<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Опросник с монетами</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none; }
    .pill { padding: 2px 6px; border-radius: 8px; font-size: 0.9em; }
  </style>
</head>
<body>
  <h1>Опросник с монетами</h1>
  <div id="organizer">
    <h2>Организатор</h2>
    <input id="poll-title" placeholder="Название опроса"><br>
    <button onclick="createPoll()">Создать опрос</button>
    <div id="organizer-panel" class="hidden">
      <h3 id="o-title"></h3>
      <button onclick="openPoll()">Открыть опрос</button>
      <button onclick="closePoll()">Закрыть опрос</button>
      <p>Статус: <span id="o-status" class="pill"></span></p>
      <canvas id="chart"></canvas>
    </div>
  </div>
  <hr>
  <div id="voter">
    <h2>Участник</h2>
    <input id="v-code" placeholder="Код доступа"><br>
    <button onclick="joinByCode($('#v-code').value)">Присоединиться</button>
    <p id="join-msg"></p>
    <div id="voter-info" class="hidden">
      <h3 id="v-poll-title"></h3>
      <span id="v-status-pill" class="pill"></span>
      <p>Ваш бюджет: <span id="v-budget"></span> монет</p>
      <form id="voter-form" class="hidden"></form>
      <p>Оставшиеся монеты: <span id="v-remaining"></span></p>
      <button onclick="submitVote()">Отправить голоса</button>
    </div>
  </div>

  <script>
  const $ = sel => document.querySelector(sel);

  // ===== store (локальное хранилище) =====
  const store = {
    set: (k,v) => localStorage.setItem(k, JSON.stringify(v)),
    get: (k) => { let v = localStorage.getItem(k); try { return JSON.parse(v); } catch(e){ return v; } },
    del: (k) => localStorage.removeItem(k)
  };

  let current = { poll: null, bc: null };
  let vState = { code: null, pollId: null, budget: 0, allocations: {} };

  // ======= GUN.JS РЕАЛЬНОЕ ВРЕМЯ =======
  let gun = null;
  (function initGun(){
    try {
      const peersParam = new URLSearchParams(location.search).get('peers');
      const defaultPeers = ['https://gun-manhattan.herokuapp.com/gun'];
      const peers = (peersParam ? peersParam.split(',') : defaultPeers).map(s=>s.trim()).filter(Boolean);
      if (typeof Gun !== 'undefined') {
        gun = Gun({ peers, retry: Infinity });
        console.log('[GUN] peers:', peers);
      }
    } catch(e) { console.warn('[GUN] init failed', e); }
  })();

  const net = {
    putPoll(poll){ if(!gun || !poll?.id) return;
      try { gun.get('polls').get(poll.id).put({ data: JSON.stringify(poll), ts: Date.now() }); } catch(e){}
    },
    onPoll(id, handler){ if(!gun || !id) return;
      gun.get('polls').get(id).on((node)=>{
        if(!node || !node.data) return;
        let obj; try { obj = JSON.parse(node.data); } catch(e){ return; }
        handler(obj, Number(node.ts)||0);
      });
    },
    setCode(codeUpper, pid){ if(!gun || !codeUpper || !pid) return;
      try { gun.get('codes').get(codeUpper).put(pid); } catch(e){}
    },
    getPollOnce(id){ if(!gun || !id) return Promise.resolve(null);
      return new Promise(res => {
        let done=false;
        gun.get('polls').get(id).once(node => {
          if(done) return; done=true;
          try { res(node && node.data ? JSON.parse(node.data) : null); } catch(e){ res(null); }
        });
        setTimeout(()=>{ if(!done) res(null); }, 4000);
      });
    },
    getPollIdByCode(codeUpper){ if(!gun || !codeUpper) return Promise.resolve(null);
      return new Promise(res => {
        let done=false;
        gun.get('codes').get(codeUpper).once(pid => { done=true; res(pid||null); });
        setTimeout(()=>{ if(!done) res(null); }, 3000);
      });
    }
  };

  // ===== функции работы с опросом =====
  function createPoll(){
    const title = $('#poll-title').value.trim();
    if(!title) return;
    const poll = { id: 'p'+Date.now(), title, status: 'new', voters: [
      { code:'ABC123', coins:5 },
      { code:'XYZ789', coins:5 }
    ], votes: {}, options: ['Вариант 1','Вариант 2','Вариант 3'], _ts: Date.now() };
    current.poll = poll;
    store.set('poll:'+poll.id, poll);
    $('#o-title').textContent = poll.title;
    $('#organizer-panel').classList.remove('hidden');
    savePoll();
    registerCodes();
    startNetSync();
    try { net.putPoll(current.poll); } catch(e){}
  }

  function savePoll(){
    if(!current.poll) return;
    current.poll._ts = Date.now();
    store.set('poll:' + current.poll.id, current.poll);
    localStorage.setItem('poll:sig', String(current.poll._ts));
    if(current.bc) current.bc.postMessage({ t:'updated', id: current.poll.id });
    try { net.putPoll(current.poll); } catch(e){}
    drawAll();
    $('#o-status').textContent = current.poll.status;
  }

  function registerCodes(){
    const map = store.get('access:map') || {};
    (current.poll?.voters||[]).forEach(v => {
      if(v.code){
        const up = (v.code||'').toUpperCase();
        map[up] = current.poll.id;
        try { net.setCode(up, current.poll.id); } catch(e){}
      }
    });
    store.set('access:map', map);
  }

  function startNetSync(){
    if(!gun || !current.poll) return;
    try {
      net.onPoll(current.poll.id, (obj, ts)=>{
        const localTs = Number(current.poll?._ts||0);
        if(ts && localTs && ts <= localTs) return;
        current.poll = obj;
        store.set('poll:' + obj.id, obj);
        $('#o-title').textContent = obj.title;
        $('#o-status').textContent = obj.status;
        renderOptions();
        renderVoters();
        drawAll();
      });
    } catch(e){ console.warn('[GUN] subscribe failed', e); }
  }

  function openPoll(){ if(!current.poll) return; current.poll.status = 'open'; savePoll(); }
  function closePoll(){ if(!current.poll) return; current.poll.status = 'closed'; savePoll(); }

  async function joinByCode(code){
    code = (code||'').trim().toUpperCase();
    $('#v-code').value = code;
    let poll = findPollByCode(code);
    if(!poll){
      $('#join-msg').textContent = 'Ищем код в сети...';
      const pid = await net.getPollIdByCode(code);
      if(pid){
        const remote = await net.getPollOnce(pid);
        if(remote){
          store.set('poll:'+pid, remote);
          poll = remote;
        }
      }
    }
    if(!poll){ $('#join-msg').textContent = 'Код не найден.'; return; }
    current.poll = poll;
    startNetSync();
    const voter = poll.voters.find(v=> (v.code||'').toUpperCase()===code);
    if(!voter){ $('#join-msg').textContent = 'Код не найден в списке.'; return; }
    vState.code = code; vState.pollId = poll.id; vState.budget = Number(voter.coins)||0;
    vState.allocations = Object.assign({}, poll.votes[code]||{});
    $('#voter-info').classList.remove('hidden');
    $('#voter-form').classList.remove('hidden');
    $('#v-poll-title').textContent = poll.title;
    $('#v-status-pill').textContent = poll.status;
    $('#v-budget').textContent = vState.budget;
    renderAllocationForm();
    updateRemaining();
  }

  function findPollByCode(code){
    const map = store.get('access:map')||{};
    const id = map[code];
    if(id) return store.get('poll:'+id);
    return null;
  }

  function renderOptions(){ /* список опций */ }
  function renderVoters(){ /* список участников */ }

  function renderAllocationForm(){
    const form = $('#voter-form');
    form.innerHTML = '';
    (current.poll?.options||[]).forEach(opt => {
      const input = document.createElement('input');
      input.type='number'; input.value=vState.allocations[opt]||0;
      input.onchange = e=>{ vState.allocations[opt]=+e.target.value; updateRemaining(); };
      form.append(opt, input, document.createElement('br'));
    });
  }

  function updateRemaining(){
    const used = Object.values(vState.allocations).reduce((a,b)=>a+b,0);
    $('#v-remaining').textContent = vState.budget - used;
  }

  function submitVote(){
    if(!current.poll) return;
    current.poll.votes[vState.code] = vState.allocations;
    savePoll();
  }

  function drawAll(){
    if(!current.poll) return;
    const ctx = $('#chart');
    if(!ctx) return;
    const totals = {};
    (current.poll.options||[]).forEach(o=> totals[o]=0);
    for(const code in current.poll.votes){
      const alloc = current.poll.votes[code];
      for(const o in alloc){ totals[o]+=alloc[o]; }
    }
    new Chart(ctx,{ type:'bar', data:{ labels:Object.keys(totals), datasets:[{ label:'Голоса', data:Object.values(totals)}] } });
  }

  function setupBroadcast(){
    current.bc = new BroadcastChannel('poll');
    current.bc.onmessage = (ev)=>{
      if(ev.data.t==='updated'){
        const poll = store.get('poll:'+ev.data.id);
        if(poll){ current.poll = poll; renderOptions(); renderVoters(); drawAll(); }
      }
    };
  }

  if (current.poll) {
    setupBroadcast();
    startNetSync();
    try { net.putPoll(current.poll); } catch(e){}
  }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Опросник с монетами</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- ✅ Подключаем Gun.js -->
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none; }
    .pill { padding: 2px 6px; border-radius: 8px; font-size: 0.9em; }
  </style>
</head>
<body>
  <h1>Опросник с монетами</h1>
  <div id="organizer">
    <h2>Организатор</h2>
    <input id="poll-title" placeholder="Название опроса"><br>
    <button onclick="createPoll()">Создать опрос</button>
    <div id="organizer-panel" class="hidden">
      <h3 id="o-title"></h3>
      <button onclick="openPoll()">Открыть опрос</button>
      <button onclick="closePoll()">Закрыть опрос</button>
      <p>Статус: <span id="o-status" class="pill"></span></p>
      <canvas id="chart"></canvas>
    </div>
  </div>
  <hr>
  <div id="voter">
    <h2>Участник</h2>
    <input id="v-code" placeholder="Код доступа"><br>
    <button onclick="joinByCode($('#v-code').value)">Присоединиться</button>
    <p id="join-msg"></p>
    <div id="voter-info" class="hidden">
      <h3 id="v-poll-title"></h3>
      <span id="v-status-pill" class="pill"></span>
      <p>Ваш бюджет: <span id="v-budget"></span> монет</p>
      <form id="voter-form" class="hidden"></form>
      <p>Оставшиеся монеты: <span id="v-remaining"></span></p>
      <button onclick="submitVote()">Отправить голоса</button>
    </div>
  </div>

  <script>
  const $ = sel => document.querySelector(sel);

  // ===== store (локальное хранилище) =====
  const store = {
    set: (k,v) => localStorage.setItem(k, JSON.stringify(v)),
    get: (k) => { let v = localStorage.getItem(k); try { return JSON.parse(v); } catch(e){ return v; } },
    del: (k) => localStorage.removeItem(k)
  };

  let current = { poll: null, bc: null };
  let vState = { code: null, pollId: null, budget: 0, allocations: {} };

  // ======= GUN: инициализация =======
  let gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);

  // ===== функции работы с опросом =====
  function createPoll(){
    const title = $('#poll-title').value.trim();
    if(!title) return;
    const poll = { 
      id: 'p'+Date.now(), 
      title, 
      status: 'new', 
      voters: [
        { code:'ABC123', coins:5 },
        { code:'XYZ789', coins:5 }
      ], 
      votes: {}, 
      options: ['Вариант 1','Вариант 2','Вариант 3'], 
      _ts: Date.now() 
    };
    current.poll = poll;
    store.set('poll:'+poll.id, poll);
    $('#o-title').textContent = poll.title;
    $('#organizer-panel').classList.remove('hidden');
    savePoll();
    setupBroadcast();
    startNetSync();
  }

  function savePoll(){
    if(!current.poll) return;
    current.poll._ts = Date.now();
    store.set('poll:' + current.poll.id, current.poll);
    localStorage.setItem('poll:sig', String(current.poll._ts));
    if(current.bc) current.bc.postMessage({ t:'updated', id: current.poll.id });

    // === Gun.js публикация (только «чистые» данные) ===
    const cleanPoll = {
      id: current.poll.id,
      title: current.poll.title,
      status: current.poll.status,
      options: current.poll.options,
      voters: current.poll.voters,
      votes: current.poll.votes,
      _ts: current.poll._ts
    };
    gun.get('polls').get(current.poll.id).put(cleanPoll);
  }

  function startNetSync(){
    if(!gun || !current.poll) return;
    gun.get('polls').get(current.poll.id).on(data=>{
      if(!data) return;
      try{
        current.poll = {
          ...current.poll,
          id: data.id,
          title: data.title,
          status: data.status,
          options: data.options,
          voters: data.voters,
          votes: data.votes,
          _ts: data._ts
        };
        drawAll();
        refreshInfo();
      }catch(e){ console.warn('Ошибка sync', e); }
    });
  }

  function openPoll(){ if(!current.poll) return; current.poll.status = 'open'; savePoll(); }
  function closePoll(){ if(!current.poll) return; current.poll.status = 'closed'; savePoll(); }

  async function joinByCode(code){
    code = (code||'').trim().toUpperCase();
    $('#v-code').value = code;
    const voter = (current.poll?.voters||[]).find(v=> (v.code||'').toUpperCase()===code);
    if(!voter){ $('#join-msg').textContent = 'Код не найден.'; return; }
    vState.code = code; 
    vState.pollId = current.poll.id; 
    vState.budget = Number(voter.coins)||0;
    vState.allocations = Object.assign({}, current.poll.votes[code]||{});
    $('#voter-info').classList.remove('hidden');
    $('#voter-form').classList.remove('hidden');
    $('#v-poll-title').textContent = current.poll.title;
    $('#v-status-pill').textContent = current.poll.status;
    $('#v-budget').textContent = vState.budget;
    renderAllocationForm();
    updateRemaining();
    startNetSync();
  }

  function renderAllocationForm(){
    const form = $('#voter-form');
    form.innerHTML = '';
    (current.poll?.options||[]).forEach(opt => {
      const input = document.createElement('input');
      input.type='number'; input.value=vState.allocations[opt]||0;
      input.onchange = e=>{ vState.allocations[opt]=+e.target.value; updateRemaining(); };
      form.append(opt, input, document.createElement('br'));
    });
  }

  function updateRemaining(){
    const used = Object.values(vState.allocations).reduce((a,b)=>a+b,0);
    $('#v-remaining').textContent = vState.budget - used;
  }

  function submitVote(){
    if(!current.poll) return;
    current.poll.votes[vState.code] = vState.allocations;
    savePoll();
  }

  function drawAll(){
    if(!current.poll) return;
    const ctx = $('#chart');
    if(!ctx) return;
    const totals = {};
    (current.poll.options||[]).forEach(o=> totals[o]=0);
    for(const code in current.poll.votes){
      const alloc = current.poll.votes[code];
      for(const o in alloc){ totals[o]+=alloc[o]; }
    }
    new Chart(ctx,{ type:'bar', data:{ labels:Object.keys(totals), datasets:[{ label:'Голоса', data:Object.values(totals)}] } });
  }

  function refreshInfo(){
    if(!current.poll) return;
    $('#o-title').textContent = current.poll.title;
    $('#o-status').textContent = current.poll.status;
    $('#v-poll-title').textContent = current.poll.title;
    $('#v-status-pill').textContent = current.poll.status;
  }

  function setupBroadcast(){
    if(current.bc) current.bc.close();
    current.bc = new BroadcastChannel('poll');
    current.bc.onmessage = (ev)=>{
      if(ev.data.t==='updated'){
        const poll = store.get('poll:'+ev.data.id);
        if(poll){ current.poll = poll; drawAll(); refreshInfo(); }
      }
    };
  }
  </script>
</body>
</html>

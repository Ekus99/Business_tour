<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Опросник с монетами — Организатор и Участник</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- ДОБАВЛЯЕМ GUN.JS -->
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/radix.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/radisk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/store.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/rindexed.js"></script>
  <style>
    /* ... (все стили остаются без изменений) ... */
  </style>
</head>
<body>
  <!-- ... (HTML структура без изменений) ... -->

  <script>
    // ======= УТИЛИТЫ =======
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const randCode = () => 'V-' + Math.random().toString(36).substring(2, 8).toUpperCase();
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

    // ======= GUN.JS ИНИЦИАЛИЗАЦИЯ =======
    let gun = null;
    let gunUser = null;
    
    function initGun() {
      // Используем публичные пиры Gun.js для демонстрации
      gun = Gun(['https://gun-manhattan.herokuapp.com/gun', 'https://gun-us.herokuapp.com/gun']);
      
      // Создаем анонимного пользователя для синхронизации
      gunUser = gun.user().recall({ sessionStorage: true });
      
      console.log('Gun.js инициализирован');
    }

    // ======= СИНХРОНИЗАЦИЯ С GUN.JS =======
    function syncPollToGun(poll) {
      if (!gun || !poll) return;
      
      // Синхронизируем весь опрос в Gun.js
      const pollNode = gun.get('polls').get(poll.id);
      
      // Сохраняем данные опроса
      pollNode.put({
        id: poll.id,
        title: poll.title,
        status: poll.status,
        options: poll.options,
        voters: poll.voters,
        votes: poll.votes,
        updatedAt: Date.now()
      });
      
      // Также сохраняем карту кодов доступа
      const accessMap = store.get('access:map') || {};
      gun.get('accessMap').put(accessMap);
      
      console.log('Опрос синхронизирован с Gun.js');
    }

    function loadPollFromGun(pollId, callback) {
      if (!gun) {
        if (callback) callback(null);
        return;
      }
      
      gun.get('polls').get(pollId).once((data) => {
        if (data && typeof data === 'object') {
          // Восстанавливаем полную структуру опроса
          const poll = {
            id: data.id || pollId,
            title: data.title || '',
            status: data.status || 'draft',
            options: data.options || [],
            voters: data.voters || [],
            votes: data.votes || {}
          };
          
          if (callback) callback(poll);
        } else {
          if (callback) callback(null);
        }
      });
    }

    function findPollByCodeGun(code, callback) {
      if (!gun) {
        if (callback) callback(null);
        return;
      }
      
      // Получаем карту кодов из Gun.js
      gun.get('accessMap').once((accessMap) => {
        const codeKey = (code || '').toUpperCase();
        const pollId = accessMap ? accessMap[codeKey] : null;
        
        if (pollId) {
          loadPollFromGun(pollId, callback);
        } else {
          if (callback) callback(null);
        }
      });
    }

    // ======= ОБНОВЛЕННОЕ ЛОКАЛЬНОЕ ХРАНИЛИЩЕ =======
    const store = {
      get(key){ try { return JSON.parse(localStorage.getItem(key)); } catch(e){ return null; } },
      set(key,val){ 
        localStorage.setItem(key, JSON.stringify(val)); 
        // Синхронизируем с Gun.js при изменении важных данных
        if (key.startsWith('poll:')) {
          syncPollToGun(val);
        }
      },
      del(key){ localStorage.removeItem(key); }
    };

    // ======= ОБНОВЛЕННЫЕ ФУНКЦИИ РАБОТЫ С ОПРОСАМИ =======
    function newPoll(){
      const poll = {
        id: uid(),
        title: '',
        status: 'draft',
        options: [],
        voters: [],
        votes: {}
      };
      current.poll = poll;
      store.set('poll:' + poll.id, poll);
      const my = store.get('my-polls') || [];
      if(!my.includes(poll.id)) { my.unshift(poll.id); store.set('my-polls', my); }
      renderOptions();
      renderVoters();
      refreshInfo();
      $('#poll-title').value = '';
      
      // Синхронизируем с Gun.js
      syncPollToGun(poll);
    }

    function loadPoll(id){
      // Сначала пробуем загрузить из Gun.js
      loadPollFromGun(id, (gunPoll) => {
        if (gunPoll) {
          // Обновляем локальное хранилище из облака
          current.poll = gunPoll;
          store.set('poll:' + id, gunPoll);
          renderOptions();
          renderVoters();
          $('#poll-title').value = gunPoll.title || '';
          refreshInfo();
          drawAll();
        } else {
          // Fallback на локальное хранилище
          const p = store.get('poll:' + id);
          if(!p) return false;
          current.poll = p;
          renderOptions();
          renderVoters();
          $('#poll-title').value = p.title || '';
          refreshInfo();
          
          // Синхронизируем локальные данные с Gun.js
          syncPollToGun(p);
        }
      });
      
      return true;
    }

    function findPollByCode(code){
      const codeKey = (code||'').toUpperCase();
      
      // Сначала пробуем найти через Gun.js
      findPollByCodeGun(code, (gunPoll) => {
        if (gunPoll) {
          current.poll = gunPoll;
          refreshInfo();
        } else {
          // Fallback на локальную карту
          const map = store.get('access:map') || {};
          const pid = map[codeKey];
          if(!pid) return null;
          const localPoll = store.get('poll:' + pid);
          if (localPoll) {
            current.poll = localPoll;
            refreshInfo();
          }
        }
      });
      
      return current.poll;
    }

    // ======= ОБНОВЛЕННАЯ ФУНКЦИЯ JOIN BY CODE =======
    function joinByCode(code){
      code = (code||'').trim().toUpperCase();
      $('#v-code').value = code;
      
      // Используем Gun.js для поиска опроса
      findPollByCodeGun(code, (poll) => {
        if (!poll) {
          $('#join-msg').textContent = 'Код не найден. Проверьте правильность или обратитесь к организатору.';
          return;
        }
        
        current.poll = poll;
        refreshInfo();
        const voter = poll.voters.find(v=> (v.code||'').toUpperCase()===code);
        if(!voter){
          $('#join-msg').textContent = 'Код не найден в списке участников.';
          return;
        }
        if(poll.status==='closed'){
          $('#join-msg').textContent = 'Опрос завершен. Отправка новых голосов недоступна.';
        }

        vState.code = code;
        vState.pollId = poll.id;
        vState.budget = Number(voter.coins)||0;
        vState.allocations = Object.assign({}, poll.votes[code]||{});
        
        $('#voter-info').style.display='block';
        $('#voter-form').style.display='block';
        $('#v-poll-title').textContent = poll.title || 'Опрос';
        $('#v-status-pill').textContent = poll.status;
        $('#v-budget').textContent = vState.budget;
        
        renderAllocationForm();
        updateRemaining();
        
        $('#join-msg').textContent = voter.submitted ?
          'Вы уже голосовали. Можно обновить голос до завершения опроса.' :
          'Готово: можно голосовать.';
      });
    }

    // ======= ОБНОВЛЕННАЯ ФУНКЦИЯ SAVE POLL =======
    function savePoll(){
      if(!current.poll) return;
      store.set('poll:' + current.poll.id, current.poll);
      localStorage.setItem('poll:sig', String(Date.now()));
      
      // Синхронизируем с Gun.js
      syncPollToGun(current.poll);
      
      if(current.bc) current.bc.postMessage({ t:'updated', id: current.poll.id });
    }

    // ======= ОБНОВЛЕННЫЙ СТАРТ =======
    (function start(){
      // Инициализируем Gun.js
      initGun();
      
      const q = new URLSearchParams(location.search);
      let injectedId = null;
      const dataRaw = q.get('data');
      
      if(dataRaw){
        const decoded = decodeURIComponent(dataRaw);
        const obj = decodeShare(decoded);
        if(obj && obj.id){
          store.set('poll:' + obj.id, obj);
          injectedId = obj.id;
          syncPollToGun(obj);
        }
      }
      
      const pid = q.get('poll') || injectedId;
      if(!pid) newPoll(); else loadPoll(pid);
      
      if(injectedId){ try { registerCodes(); } catch(e){} }
      
      refreshInfo();
      drawAll();
      initFromQuery();
      
      if(current.poll) setupBroadcast();
      
      // Подписываемся на обновления из Gun.js
      if (gun && current.poll) {
        gun.get('polls').get(current.poll.id).on((data) => {
          if (data && typeof data === 'object' && data.id === current.poll.id) {
            // Обновляем локальные данные при изменениях извне
            current.poll = data;
            store.set('poll:' + data.id, data);
            renderOptions();
            renderVoters();
            refreshInfo();
            drawAll();
          }
        });
      }
    })();

    // Остальной код остается без изменений...
    // ======= КОДИРОВАНИЕ/ДЕКОДИРОВАНИЕ =======
    function encodeShare(obj){ /* ... */ }
    function decodeShare(s){ /* ... */ }

    // ======= ГЛОБАЛЬНОЕ СОСТОЯНИЕ =======
    let current = { poll: null, chart: null, screenChart: null, bc: null };

    // ======= ОСТАЛЬНЫЕ ФУНКЦИИ БЕЗ ИЗМЕНЕНИЙ =======
    function refreshInfo(){ /* ... */ }
    function registerCodes(){ /* ... */ }
    function renderOptions(){ /* ... */ }
    function renderVoters(){ /* ... */ }
    function tally(){ /* ... */ }
    function drawAll(){ /* ... */ }
    function drawChart(sel){ /* ... */ }
    function fillResultsTable(){ /* ... */ }
    // ... и все остальные функции

  </script>
</body>
</html>
